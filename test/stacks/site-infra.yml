---
- name: Make sure stack directory exists
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  loop:
    - /srv/site-infra
    - /srv/site-infra/traefik
    - /srv/site-infra/traefik/certs

- name: Deploy traefik startup and dynamic configs
  ansible.builtin.copy:
    src: "templates/{{ item }}"
    dest: "/srv/site-infra/traefik/{{ item }}"
    mode: "0644"
  loop:
    - traefik.yml
    - traefik-dynamic-configuration.yml

- name: Deploy Cloudflare origin server cert
  ansible.builtin.copy:
    src: "../keys/{{ item.src_name }}"
    dest: "/srv/site-infra/traefik/certs/{{ item.dst_name }}"
    mode: "0600"
  loop:
    - src_name: cloudflare-origin-server.cert
      dst_name: origin-server.cert
    - src_name: cloudflare-origin-server.key
      dst_name: origin-server.key

- name: Make sure ingress networks exists
  community.docker.docker_network:
    name: "{{ item }}"
    driver: overlay
    # https://www.reddit.com/r/portainer/comments/qt1mne/swarm_deployment_woes/
    driver_options:
      com.docker.network.driver.mtu: 1450
  loop:
    - cloudflarenet
    - traefiknet

- name: Deploy the site infra stack
  community.docker.docker_stack:
    name: site-infra
    resolve_image: never
    with_registry_auth: true
    prune: true
    compose:
      - version: "3.8"

        networks:
          cloudflarenet:
            external: true
          traefiknet:
            external: true

        services:
          cloudflared:
            image: cloudflare/cloudflared:2024.11.1
            command: "tunnel --no-autoupdate run --token {{ secrets.cloudflare.tunnel_token }}"
            networks:
              - cloudflarenet

          traefik:
            image: traefik:v3.2.1
            ports:
              - "80:80"
              - "443:443"
              - "8080:8080"
            volumes:
              - /var/run/docker.sock:/var/run/docker.sock:ro
              - /srv/site-infra/traefik/traefik.yml:/traefik.yml
              - /srv/site-infra/traefik/traefik-dynamic-configuration.yml:/traefik-dynamic-configuration.yml
              - /srv/site-infra/traefik/certs:/certs/
            networks:
              - traefiknet

          periodic-prune:
            image: f213/periodic-docker-prune:1.1.1
            deploy:
              mode: global
            volumes:
              - /var/run/docker.sock:/var/run/docker.sock
